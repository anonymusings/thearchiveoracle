# Design Document: Sidebar Settings Panel

## Overview

This feature adds a settings panel to the reader interface sidebar, allowing users to customize their reading experience. The panel includes font size controls, line spacing controls, theme selection, and a restore defaults option. All settings persist via cookies and apply only to the main content viewer area (.epub-chapter).

## Main Algorithm/Workflow

```mermaid
sequenceDiagram
    participant User
    participant SettingsButton
    participant SettingsDialog
    participant CookieStorage
    participant ContentArea
    
    User->>SettingsButton: Click settings button
    SettingsButton->>SettingsDialog: Toggle dialog visibility
    SettingsDialog-->>User: Show/hide dialog
    
    User->>SettingsDialog: Adjust font size
    SettingsDialog->>ContentArea: Apply font size change
    SettingsDialog->>CookieStorage: Save setting
    
    User->>SettingsDialog: Adjust line spacing
    SettingsDialog->>ContentArea: Apply line spacing change
    SettingsDialog->>CookieStorage: Save setting
    
    User->>SettingsDialog: Select theme
    SettingsDialog->>ContentArea: Apply theme change
    SettingsDialog->>CookieStorage: Save setting
    
    User->>SettingsDialog: Click restore defaults
    SettingsDialog->>SettingsDialog: Show confirmation dialog
    User->>SettingsDialog: Confirm restore
    SettingsDialog->>ContentArea: Apply default settings
    SettingsDialog->>CookieStorage: Clear saved settings
```


## Core Interfaces/Types

```typescript
interface ReaderSettings {
  fontSize: number;        // Percentage: 30-200
  lineHeight: number;      // Multiplier: 0.5-3.0
  theme: 'white' | 'black' | 'beige';
}

interface SettingsState {
  isDialogOpen: boolean;
  isConfirmationOpen: boolean;
}

const DEFAULT_SETTINGS: ReaderSettings = {
  fontSize: 100,
  lineHeight: 1.85,
  theme: 'white'
};

const THEME_COLORS = {
  white: { background: '#FFFFFF', text: '#1a1a1a' },
  black: { background: '#000000', text: '#d4c4ad' },
  beige: { background: '#F2EADE', text: '#2a1e18' }
};
```


## Key Functions with Formal Specifications

### Function 1: toggleSettingsDialog()

```typescript
function toggleSettingsDialog(): void
```

**Preconditions:**
- Settings button exists in DOM
- Settings dialog exists in DOM
- Reader page is active

**Postconditions:**
- Dialog visibility is toggled (open ↔ closed)
- Button icon changes to reflect state (2.svg ↔ 1.svg with hover color)
- If closing, confirmation dialog is also closed
- No other dialogs are affected

**Loop Invariants:** N/A

### Function 2: adjustFontSize(delta: number)

```typescript
function adjustFontSize(delta: number): void
```

**Preconditions:**
- `delta` is either +5 or -5 (percentage points)
- Current fontSize is within valid range [30, 200]
- .epub-chapter element exists in DOM

**Postconditions:**
- fontSize is updated by delta, clamped to [30, 200]
- New fontSize is applied to .epub-chapter element
- New fontSize is saved to cookies
- Visual feedback is provided (button glow effect)

**Loop Invariants:** N/A


### Function 3: adjustLineHeight(delta: number)

```typescript
function adjustLineHeight(delta: number): void
```

**Preconditions:**
- `delta` is either +0.5 or -0.5
- Current lineHeight is within valid range [0.5, 3.0]
- .epub-chapter element exists in DOM

**Postconditions:**
- lineHeight is updated by delta, clamped to [0.5, 3.0]
- New lineHeight is applied to .epub-chapter element
- New lineHeight is saved to cookies
- Visual feedback is provided (button glow effect)

**Loop Invariants:** N/A

### Function 4: setTheme(theme: string)

```typescript
function setTheme(theme: 'white' | 'black' | 'beige'): void
```

**Preconditions:**
- `theme` is one of: 'white', 'black', 'beige'
- .epub-chapter element exists in DOM
- #reader-main element exists in DOM

**Postconditions:**
- Theme is applied to reader-main background and epub-chapter text color
- Selected theme circle has crimson glow effect
- Previously selected theme circle loses glow effect
- Theme is saved to cookies

**Loop Invariants:** N/A


### Function 5: restoreDefaults()

```typescript
function restoreDefaults(): void
```

**Preconditions:**
- Confirmation dialog is visible
- User has clicked "Restore" button
- .epub-chapter element exists in DOM

**Postconditions:**
- All settings are reset to DEFAULT_SETTINGS values
- Default settings are applied to .epub-chapter element
- All setting cookies are deleted
- Confirmation dialog is closed
- Settings dialog remains open showing updated values

**Loop Invariants:** N/A

### Function 6: loadSettingsFromCookies()

```typescript
function loadSettingsFromCookies(): ReaderSettings
```

**Preconditions:**
- Function is called on page load or reader initialization
- Cookie API is available

**Postconditions:**
- Returns ReaderSettings object with values from cookies
- If cookies don't exist, returns DEFAULT_SETTINGS
- Invalid cookie values are clamped to valid ranges
- No side effects on DOM or application state

**Loop Invariants:** N/A


## Algorithmic Pseudocode

### Main Settings Panel Initialization

```pascal
ALGORITHM initializeSettingsPanel()
INPUT: None
OUTPUT: Initialized settings panel with event listeners

BEGIN
  ASSERT settingsButton exists in DOM
  ASSERT settingsDialog exists in DOM
  
  // Step 1: Load saved settings from cookies
  settings ← loadSettingsFromCookies()
  
  // Step 2: Apply loaded settings to content area
  applyReaderStyles(settings)
  
  // Step 3: Attach event listeners
  settingsButton.addEventListener('click', toggleSettingsDialog)
  
  FOR each fontSizeButton IN fontSizeButtons DO
    fontSizeButton.addEventListener('click', handleFontSizeClick)
  END FOR
  
  FOR each lineHeightButton IN lineHeightButtons DO
    lineHeightButton.addEventListener('click', handleLineHeightClick)
  END FOR
  
  FOR each themeCircle IN themeCircles DO
    themeCircle.addEventListener('click', handleThemeClick)
  END FOR
  
  restoreDefaultLink.addEventListener('click', showConfirmationDialog)
  confirmRestoreButton.addEventListener('click', restoreDefaults)
  cancelRestoreButton.addEventListener('click', hideConfirmationDialog)
  
  ASSERT all event listeners are attached
  
  RETURN success
END
```

**Preconditions:**
- DOM is fully loaded
- All required HTML elements exist
- Cookie API is available

**Postconditions:**
- Settings panel is initialized with saved or default values
- All event listeners are attached
- Settings are applied to content area
- Panel is ready for user interaction


### Font Size Adjustment Algorithm

```pascal
ALGORITHM adjustFontSize(delta)
INPUT: delta of type number (±5)
OUTPUT: Updated font size applied to content

BEGIN
  ASSERT delta = 5 OR delta = -5
  ASSERT readerFontSize is defined
  
  // Step 1: Calculate new font size
  newFontSize ← readerFontSize + delta
  
  // Step 2: Clamp to valid range
  IF newFontSize < 30 THEN
    newFontSize ← 30
  END IF
  
  IF newFontSize > 200 THEN
    newFontSize ← 200
  END IF
  
  // Step 3: Update global state
  readerFontSize ← newFontSize
  
  // Step 4: Apply to content area
  chapter ← document.querySelector('.epub-chapter')
  ASSERT chapter ≠ NULL
  
  baseFontSize ← 1.05
  actualSize ← (baseFontSize × readerFontSize / 100)
  chapter.style.fontSize ← actualSize + 'rem'
  
  // Step 5: Save to cookies
  setCookie('readerFontSize', readerFontSize, 365)
  
  ASSERT 30 ≤ readerFontSize ≤ 200
  ASSERT chapter.style.fontSize is updated
  
  RETURN success
END
```

**Preconditions:**
- delta is ±5
- readerFontSize is initialized
- .epub-chapter element exists

**Postconditions:**
- readerFontSize is within [30, 200]
- Font size is applied to .epub-chapter
- Setting is persisted to cookies


### Theme Selection Algorithm

```pascal
ALGORITHM setTheme(themeName)
INPUT: themeName of type string ('white', 'black', or 'beige')
OUTPUT: Theme applied to reader interface

BEGIN
  ASSERT themeName ∈ {'white', 'black', 'beige'}
  
  // Step 1: Get theme colors
  themeConfig ← THEME_COLORS[themeName]
  ASSERT themeConfig ≠ NULL
  
  // Step 2: Apply background color
  readerMain ← document.getElementById('reader-main')
  ASSERT readerMain ≠ NULL
  readerMain.style.background ← themeConfig.background
  
  // Step 3: Apply text color
  chapter ← document.querySelector('.epub-chapter')
  ASSERT chapter ≠ NULL
  chapter.style.color ← themeConfig.text
  
  // Step 4: Update visual selection indicator
  FOR each circle IN themeCircles DO
    IF circle.dataset.theme = themeName THEN
      circle.style.boxShadow ← '0 0 0 2px var(--crimson)'
    ELSE
      circle.style.boxShadow ← 'none'
    END IF
  END FOR
  
  // Step 5: Update global state
  readerTheme ← themeName
  
  // Step 6: Save to cookies
  setCookie('readerTheme', themeName, 365)
  
  ASSERT readerMain.style.background = themeConfig.background
  ASSERT chapter.style.color = themeConfig.text
  ASSERT exactly one theme circle has glow effect
  
  RETURN success
END
```

**Preconditions:**
- themeName is valid ('white', 'black', or 'beige')
- Required DOM elements exist
- THEME_COLORS configuration is defined

**Postconditions:**
- Theme colors are applied to reader interface
- Exactly one theme circle shows selection indicator
- Theme preference is saved to cookies


### Restore Defaults Algorithm

```pascal
ALGORITHM restoreDefaults()
INPUT: None
OUTPUT: All settings reset to defaults

BEGIN
  // Step 1: Reset font size
  readerFontSize ← DEFAULT_SETTINGS.fontSize
  chapter ← document.querySelector('.epub-chapter')
  ASSERT chapter ≠ NULL
  
  baseFontSize ← 1.05
  actualSize ← (baseFontSize × readerFontSize / 100)
  chapter.style.fontSize ← actualSize + 'rem'
  
  // Step 2: Reset line height
  readerLineHeight ← DEFAULT_SETTINGS.lineHeight
  chapter.style.lineHeight ← readerLineHeight
  
  // Step 3: Reset theme
  readerTheme ← DEFAULT_SETTINGS.theme
  setTheme(readerTheme)
  
  // Step 4: Clear cookies
  deleteCookie('readerFontSize')
  deleteCookie('readerLineHeight')
  deleteCookie('readerTheme')
  
  // Step 5: Close confirmation dialog
  confirmationDialog.style.display ← 'none'
  
  ASSERT readerFontSize = 100
  ASSERT readerLineHeight = 1.85
  ASSERT readerTheme = 'white'
  ASSERT all setting cookies are deleted
  
  RETURN success
END
```

**Preconditions:**
- User has confirmed restore action
- .epub-chapter element exists
- DEFAULT_SETTINGS is defined

**Postconditions:**
- All settings are reset to default values
- Default settings are applied to content area
- All setting cookies are deleted
- Confirmation dialog is closed


## Example Usage

```typescript
// Example 1: Initialize settings panel on page load
document.addEventListener('DOMContentLoaded', () => {
  initializeSettingsPanel();
});

// Example 2: User increases font size
const increaseFontButton = document.getElementById('font-size-increase');
increaseFontButton.addEventListener('click', () => {
  adjustFontSize(5);  // Increase by 5%
});

// Example 3: User selects beige theme
const beigeThemeCircle = document.querySelector('[data-theme="beige"]');
beigeThemeCircle.addEventListener('click', () => {
  setTheme('beige');
});

// Example 4: User restores defaults
const restoreButton = document.getElementById('confirm-restore');
restoreButton.addEventListener('click', () => {
  restoreDefaults();
});

// Example 5: Toggle settings dialog
const settingsButton = document.getElementById('settings-button');
settingsButton.addEventListener('click', () => {
  toggleSettingsDialog();
});

// Example 6: Load settings from cookies on initialization
const savedSettings = loadSettingsFromCookies();
applyReaderStyles(savedSettings);
```


## Correctness Properties

### Universal Quantification Statements

1. **Font Size Range Invariant**
   ```
   ∀ operations: 30 ≤ readerFontSize ≤ 200
   ```
   After any font size adjustment operation, the fontSize value must remain within the valid range [30, 200].

2. **Line Height Range Invariant**
   ```
   ∀ operations: 0.5 ≤ readerLineHeight ≤ 3.0
   ```
   After any line height adjustment operation, the lineHeight value must remain within the valid range [0.5, 3.0].

3. **Theme Validity Invariant**
   ```
   ∀ theme selections: readerTheme ∈ {'white', 'black', 'beige'}
   ```
   The readerTheme variable must always contain one of the three valid theme values.

4. **Single Dialog Visibility**
   ```
   ∀ states: ¬(settingsDialog.visible ∧ confirmationDialog.visible)
   ```
   The settings dialog and confirmation dialog cannot both be visible simultaneously.

5. **Cookie Persistence**
   ```
   ∀ setting changes: setting is applied to DOM ⟹ setting is saved to cookies
   ```
   Any setting change that is applied to the DOM must also be persisted to cookies.

6. **Theme Selection Indicator**
   ```
   ∀ states: |{circle | circle.hasGlow}| = 1
   ```
   Exactly one theme circle must have the glow effect at any given time.

7. **Settings Application Scope**
   ```
   ∀ setting changes: changes apply only to .epub-chapter element
   ```
   All reader settings must only affect the .epub-chapter element, not other page elements.

8. **Button-Only Toggle**
   ```
   ∀ dialog state changes: change triggered by settingsButton.click
   ```
   The settings dialog can only be toggled by clicking the settings button, not by outside clicks.


## Architecture

### Component Structure

```mermaid
graph TD
    A[Reader Sidebar] --> B[Settings Button]
    A --> C[Settings Dialog]
    C --> D[Font Size Controls]
    C --> E[Line Spacing Controls]
    C --> F[Theme Selector]
    C --> G[Restore Default Link]
    C --> H[Confirmation Dialog]
    H --> I[Restore Button]
    H --> J[Cancel Button]
    
    B --> K[Icon State Manager]
    K --> L[2.svg - Inactive]
    K --> M[1.svg - Active/Hover]
    
    D --> N[Cookie Storage]
    E --> N
    F --> N
    G --> H
    
    N --> O[.epub-chapter Styles]
```

### Positioning Strategy

The settings button and dialog are positioned within the sidebar:
- Settings button: Fixed at bottom-right of sidebar (opposite "Back to Library" button)
- Settings dialog: Drop-up dialog appearing above the settings button
- Confirmation dialog: Replaces settings dialog content temporarily
- All elements stay within sidebar bounds (280px width)


## Components and Interfaces

### Component 1: Settings Button

**Purpose**: Toggle button to show/hide the settings dialog

**HTML Structure**:
```html
<button id="settings-button" class="sidebar-settings-btn">
  <img src="icons copy/2.svg" alt="Settings" class="settings-icon" />
</button>
```

**CSS Styling**:
```css
.sidebar-settings-btn {
  position: absolute;
  bottom: 1.5rem;
  right: 1.5rem;
  width: 44px;
  height: 44px;
  background: var(--crimson);
  border: none;
  border-radius: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: box-shadow 0.2s;
}

.sidebar-settings-btn:hover {
  box-shadow: 0 0 12px var(--crimson-glow);
}

.sidebar-settings-btn.active {
  background: var(--crimson-glow);
}

.settings-icon {
  width: 24px;
  height: 24px;
  filter: brightness(0) invert(1);
}

.sidebar-settings-btn:hover .settings-icon,
.sidebar-settings-btn.active .settings-icon {
  filter: brightness(0) saturate(100%) invert(79%) sepia(13%) saturate(1015%) hue-rotate(337deg) brightness(93%) contrast(87%);
}
```

**Responsibilities**:
- Toggle settings dialog visibility on click
- Change icon based on state (inactive: 2.svg, active/hover: 1.svg with #C9AC95 color)
- Provide visual feedback (glow effect) on hover and active states


### Component 2: Settings Dialog

**Purpose**: Container for all reader settings controls

**HTML Structure**:
```html
<div id="settings-dialog" class="settings-dialog" style="display: none;">
  <div class="settings-section">
    <label class="settings-label">Font Size</label>
    <div class="settings-control">
      <button class="settings-btn" id="font-decrease">Aa-</button>
      <button class="settings-btn" id="font-increase">Aa+</button>
    </div>
  </div>
  
  <div class="settings-section">
    <label class="settings-label">Line Spacing</label>
    <div class="settings-control">
      <button class="settings-btn" id="spacing-decrease">-</button>
      <button class="settings-btn" id="spacing-increase">+</button>
    </div>
  </div>
  
  <div class="settings-section">
    <label class="settings-label">Theme</label>
    <div class="theme-selector">
      <div class="theme-circle" data-theme="white" style="background: #FFFFFF;"></div>
      <div class="theme-circle" data-theme="black" style="background: #000000;"></div>
      <div class="theme-circle" data-theme="beige" style="background: #F2EADE;"></div>
    </div>
  </div>
  
  <a href="#" class="restore-link" id="restore-defaults">Restore default</a>
</div>
```

**CSS Styling**:
```css
.settings-dialog {
  position: absolute;
  bottom: 5rem;
  right: 1.5rem;
  width: 240px;
  background: var(--smoke-light);
  border: 1px solid rgba(111, 31, 30, 0.5);
  border-radius: 0;
  padding: 1rem;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  z-index: 250;
}

.settings-section {
  margin-bottom: 1rem;
}

.settings-section:last-of-type {
  margin-bottom: 0.75rem;
}

.settings-label {
  font-family: var(--font-display);
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--ash-light);
  display: block;
  margin-bottom: 0.5rem;
}

.settings-control {
  display: flex;
  gap: 0.5rem;
}

.settings-btn {
  flex: 1;
  background: rgba(111, 31, 30, 0.3);
  border: 1px solid rgba(111, 31, 30, 0.5);
  border-radius: 0;
  color: var(--vellum);
  padding: 0.5rem;
  font-family: var(--font-body);
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.settings-btn:hover {
  background: var(--crimson);
  box-shadow: 0 0 8px var(--crimson-glow);
}

.theme-selector {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
}

.theme-circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--ash);
  cursor: pointer;
  transition: all 0.2s;
}

.theme-circle:hover {
  border-color: var(--crimson-pale);
}

.theme-circle.selected {
  box-shadow: 0 0 0 2px var(--crimson);
}

.restore-link {
  display: block;
  text-align: center;
  font-family: var(--font-body);
  font-size: 0.85rem;
  color: var(--crimson-pale);
  text-decoration: underline;
  cursor: pointer;
  margin-top: 0.75rem;
}

.restore-link:hover {
  color: var(--white);
}
```

**Responsibilities**:
- Display all reader settings controls
- Position above settings button as drop-up dialog
- Stay within sidebar bounds
- Toggle visibility based on button clicks


### Component 3: Confirmation Dialog

**Purpose**: Confirm restore defaults action

**HTML Structure**:
```html
<div id="confirmation-dialog" class="confirmation-dialog" style="display: none;">
  <p class="confirmation-text">Restore all settings to default values?</p>
  <div class="confirmation-buttons">
    <button class="confirm-btn" id="confirm-restore">Restore</button>
    <button class="cancel-btn" id="cancel-restore">Cancel</button>
  </div>
</div>
```

**CSS Styling**:
```css
.confirmation-dialog {
  position: absolute;
  bottom: 5rem;
  right: 1.5rem;
  width: 240px;
  background: var(--smoke-light);
  border: 1px solid rgba(111, 31, 30, 0.5);
  border-radius: 0;
  padding: 1rem;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  z-index: 251;
}

.confirmation-text {
  font-family: var(--font-body);
  font-size: 0.9rem;
  color: var(--vellum);
  text-align: center;
  margin-bottom: 1rem;
  line-height: 1.5;
}

.confirmation-buttons {
  display: flex;
  gap: 0.5rem;
}

.confirm-btn,
.cancel-btn {
  flex: 1;
  padding: 0.5rem;
  border: none;
  border-radius: 0;
  font-family: var(--font-display);
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
}

.confirm-btn {
  background: var(--crimson);
  color: var(--white);
}

.confirm-btn:hover {
  background: var(--crimson-glow);
  box-shadow: 0 0 8px var(--crimson-glow);
}

.cancel-btn {
  background: rgba(111, 31, 30, 0.3);
  border: 1px solid rgba(111, 31, 30, 0.5);
  color: var(--vellum);
}

.cancel-btn:hover {
  background: rgba(111, 31, 30, 0.5);
}
```

**Responsibilities**:
- Replace settings dialog when restore defaults is clicked
- Provide "Restore" and "Cancel" buttons
- Close and return to settings dialog on cancel
- Execute restore and close on confirm


## Data Models

### Model 1: ReaderSettings

```typescript
interface ReaderSettings {
  fontSize: number;
  lineHeight: number;
  theme: string;
}
```

**Validation Rules**:
- `fontSize`: Must be integer between 30 and 200 (inclusive)
- `lineHeight`: Must be number between 0.5 and 3.0 (inclusive), increments of 0.5
- `theme`: Must be one of 'white', 'black', or 'beige'

### Model 2: SettingsState

```typescript
interface SettingsState {
  isDialogOpen: boolean;
  isConfirmationOpen: boolean;
}
```

**Validation Rules**:
- `isDialogOpen`: Boolean value
- `isConfirmationOpen`: Boolean value
- Constraint: Both cannot be true simultaneously

### Model 3: ThemeConfig

```typescript
interface ThemeConfig {
  background: string;
  text: string;
}

const THEME_COLORS: Record<string, ThemeConfig> = {
  white: { background: '#FFFFFF', text: '#1a1a1a' },
  black: { background: '#000000', text: '#d4c4ad' },
  beige: { background: '#F2EADE', text: '#2a1e18' }
};
```

**Validation Rules**:
- `background`: Must be valid hex color code
- `text`: Must be valid hex color code
- Keys must match valid theme names


## Error Handling

### Error Scenario 1: Missing DOM Elements

**Condition**: Required DOM elements (.epub-chapter, #reader-main, etc.) do not exist
**Response**: Log error to console and gracefully skip operation
**Recovery**: Check for element existence before each operation

```typescript
function applyReaderStyles(settings: ReaderSettings): void {
  const chapter = document.querySelector('.epub-chapter');
  if (!chapter) {
    console.error('Reader content area not found');
    return;
  }
  // Continue with operation
}
```

### Error Scenario 2: Invalid Cookie Values

**Condition**: Cookie contains value outside valid range (e.g., fontSize = 300)
**Response**: Clamp value to valid range and apply
**Recovery**: Use default value if clamping fails

```typescript
function loadSettingsFromCookies(): ReaderSettings {
  let fontSize = parseInt(getCookie('readerFontSize')) || 100;
  fontSize = Math.max(30, Math.min(200, fontSize)); // Clamp to valid range
  
  let lineHeight = parseFloat(getCookie('readerLineHeight')) || 1.85;
  lineHeight = Math.max(0.5, Math.min(3.0, lineHeight)); // Clamp to valid range
  
  let theme = getCookie('readerTheme') || 'white';
  if (!['white', 'black', 'beige'].includes(theme)) {
    theme = 'white'; // Fallback to default
  }
  
  return { fontSize, lineHeight, theme };
}
```

### Error Scenario 3: Cookie Storage Failure

**Condition**: Browser blocks cookie storage (privacy settings, incognito mode)
**Response**: Settings still apply to current session but won't persist
**Recovery**: Wrap cookie operations in try-catch blocks

```typescript
function setCookie(name: string, value: string, days: number): void {
  try {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = `${name}=${value}; expires=${expires}; path=/`;
  } catch (error) {
    console.warn('Failed to save setting to cookies:', error);
  }
}
```


### Error Scenario 4: Rapid Button Clicks

**Condition**: User clicks adjustment buttons rapidly, causing multiple simultaneous operations
**Response**: Debounce or throttle operations to prevent race conditions
**Recovery**: Queue operations or ignore clicks during processing

```typescript
let isAdjusting = false;

function adjustFontSize(delta: number): void {
  if (isAdjusting) return;
  isAdjusting = true;
  
  // Perform adjustment
  readerFontSize = Math.max(30, Math.min(200, readerFontSize + delta));
  applyReaderStyles({ fontSize: readerFontSize, lineHeight: readerLineHeight, theme: readerTheme });
  setCookie('readerFontSize', readerFontSize.toString(), 365);
  
  setTimeout(() => { isAdjusting = false; }, 100);
}
```

## Testing Strategy

### Unit Testing Approach

Test individual functions in isolation:

1. **Font Size Adjustment Tests**
   - Test increasing font size within valid range
   - Test decreasing font size within valid range
   - Test clamping at minimum boundary (30%)
   - Test clamping at maximum boundary (200%)
   - Test cookie persistence after adjustment

2. **Line Height Adjustment Tests**
   - Test increasing line height within valid range
   - Test decreasing line height within valid range
   - Test clamping at minimum boundary (0.5)
   - Test clamping at maximum boundary (3.0)
   - Test cookie persistence after adjustment

3. **Theme Selection Tests**
   - Test applying each theme (white, black, beige)
   - Test theme colors are correctly applied to DOM
   - Test only one theme circle has selection indicator
   - Test cookie persistence after theme change

4. **Cookie Operations Tests**
   - Test saving settings to cookies
   - Test loading settings from cookies
   - Test handling missing cookies (defaults)
   - Test handling invalid cookie values (clamping)
   - Test deleting cookies on restore defaults

5. **Dialog Toggle Tests**
   - Test opening settings dialog
   - Test closing settings dialog
   - Test button icon state changes
   - Test confirmation dialog replaces settings dialog
   - Test cancel returns to settings dialog


### Property-Based Testing Approach

Use property-based testing to verify invariants hold across many random inputs:

**Property Test Library**: fast-check (JavaScript/TypeScript)

**Property 1: Font Size Always Within Range**
```typescript
fc.assert(
  fc.property(
    fc.integer({ min: -1000, max: 1000 }), // Random delta
    fc.integer({ min: 0, max: 300 }),      // Random initial fontSize
    (delta, initialFontSize) => {
      readerFontSize = initialFontSize;
      adjustFontSize(delta);
      return readerFontSize >= 30 && readerFontSize <= 200;
    }
  )
);
```

**Property 2: Line Height Always Within Range**
```typescript
fc.assert(
  fc.property(
    fc.float({ min: -10, max: 10 }),      // Random delta
    fc.float({ min: 0, max: 5 }),         // Random initial lineHeight
    (delta, initialLineHeight) => {
      readerLineHeight = initialLineHeight;
      adjustLineHeight(delta);
      return readerLineHeight >= 0.5 && readerLineHeight <= 3.0;
    }
  )
);
```

**Property 3: Theme Always Valid**
```typescript
fc.assert(
  fc.property(
    fc.constantFrom('white', 'black', 'beige', 'invalid', 'red', ''),
    (theme) => {
      setTheme(theme);
      return ['white', 'black', 'beige'].includes(readerTheme);
    }
  )
);
```

**Property 4: Cookie Round-Trip Preserves Values**
```typescript
fc.assert(
  fc.property(
    fc.record({
      fontSize: fc.integer({ min: 30, max: 200 }),
      lineHeight: fc.float({ min: 0.5, max: 3.0 }),
      theme: fc.constantFrom('white', 'black', 'beige')
    }),
    (settings) => {
      // Save to cookies
      setCookie('readerFontSize', settings.fontSize.toString(), 365);
      setCookie('readerLineHeight', settings.lineHeight.toString(), 365);
      setCookie('readerTheme', settings.theme, 365);
      
      // Load from cookies
      const loaded = loadSettingsFromCookies();
      
      return loaded.fontSize === settings.fontSize &&
             Math.abs(loaded.lineHeight - settings.lineHeight) < 0.01 &&
             loaded.theme === settings.theme;
    }
  )
);
```

### Integration Testing Approach

Test complete user workflows:

1. **Complete Settings Adjustment Workflow**
   - Open settings dialog
   - Adjust font size
   - Adjust line spacing
   - Change theme
   - Verify all changes applied to .epub-chapter
   - Verify all changes saved to cookies
   - Close dialog

2. **Restore Defaults Workflow**
   - Adjust all settings away from defaults
   - Click restore defaults link
   - Confirm restoration
   - Verify all settings reset to defaults
   - Verify cookies deleted
   - Verify dialog remains open

3. **Persistence Workflow**
   - Adjust settings
   - Reload page
   - Verify settings loaded from cookies
   - Verify settings applied to content


## Performance Considerations

### Optimization 1: Debounce Rapid Adjustments

When users rapidly click adjustment buttons, debounce DOM updates and cookie writes to reduce overhead:

```typescript
let adjustmentTimeout: number | null = null;

function debouncedAdjustment(applyFn: () => void): void {
  if (adjustmentTimeout) {
    clearTimeout(adjustmentTimeout);
  }
  
  adjustmentTimeout = setTimeout(() => {
    applyFn();
    adjustmentTimeout = null;
  }, 100);
}
```

### Optimization 2: Batch DOM Updates

Group multiple style changes into a single DOM update to minimize reflows:

```typescript
function applyReaderStyles(settings: ReaderSettings): void {
  const chapter = document.querySelector('.epub-chapter');
  const readerMain = document.getElementById('reader-main');
  
  if (!chapter || !readerMain) return;
  
  // Batch all style changes
  requestAnimationFrame(() => {
    const baseFontSize = 1.05;
    const actualSize = (baseFontSize * settings.fontSize / 100).toFixed(2);
    
    chapter.style.fontSize = actualSize + 'rem';
    chapter.style.lineHeight = settings.lineHeight.toString();
    
    const themeConfig = THEME_COLORS[settings.theme];
    readerMain.style.background = themeConfig.background;
    chapter.style.color = themeConfig.text;
  });
}
```

### Optimization 3: Minimize Cookie Operations

Only write to cookies when values actually change:

```typescript
function setCookieIfChanged(name: string, newValue: string, days: number): void {
  const currentValue = getCookie(name);
  if (currentValue !== newValue) {
    setCookie(name, newValue, days);
  }
}
```

### Performance Targets

- Dialog open/close: < 50ms
- Setting adjustment: < 100ms (including DOM update)
- Cookie read/write: < 10ms
- Page load with settings: < 200ms additional overhead


## Security Considerations

### Security Concern 1: Cookie Injection

**Threat**: Malicious scripts could inject invalid values into cookies
**Mitigation**: Validate and sanitize all cookie values on load

```typescript
function loadSettingsFromCookies(): ReaderSettings {
  // Validate and clamp numeric values
  let fontSize = parseInt(getCookie('readerFontSize')) || 100;
  if (isNaN(fontSize) || fontSize < 30 || fontSize > 200) {
    fontSize = 100;
  }
  
  let lineHeight = parseFloat(getCookie('readerLineHeight')) || 1.85;
  if (isNaN(lineHeight) || lineHeight < 0.5 || lineHeight > 3.0) {
    lineHeight = 1.85;
  }
  
  // Whitelist theme values
  let theme = getCookie('readerTheme') || 'white';
  if (!['white', 'black', 'beige'].includes(theme)) {
    theme = 'white';
  }
  
  return { fontSize, lineHeight, theme };
}
```

### Security Concern 2: XSS via Theme Colors

**Threat**: If theme colors were user-configurable, could inject malicious CSS
**Mitigation**: Use hardcoded theme colors only, no user input for colors

```typescript
// Safe: Hardcoded theme colors
const THEME_COLORS = {
  white: { background: '#FFFFFF', text: '#1a1a1a' },
  black: { background: '#000000', text: '#d4c4ad' },
  beige: { background: '#F2EADE', text: '#2a1e18' }
};

// Never allow: User-provided colors
// const userColor = userInput; // DANGEROUS
// element.style.background = userColor; // XSS RISK
```

### Security Concern 3: DOM Manipulation

**Threat**: Malicious scripts could manipulate settings dialog DOM
**Mitigation**: Use event delegation and validate event targets

```typescript
document.addEventListener('click', (event) => {
  const target = event.target as HTMLElement;
  
  // Validate target is expected element
  if (target.id === 'settings-button') {
    toggleSettingsDialog();
  } else if (target.classList.contains('theme-circle')) {
    const theme = target.dataset.theme;
    if (theme && ['white', 'black', 'beige'].includes(theme)) {
      setTheme(theme);
    }
  }
});
```

### Security Best Practices

1. Never use `eval()` or `innerHTML` with user-provided data
2. Always validate and sanitize cookie values
3. Use whitelist approach for theme selection
4. Clamp numeric values to valid ranges
5. Use CSP headers to prevent inline script injection


## Dependencies

### External Dependencies

None - This feature uses only vanilla JavaScript and browser APIs.

### Browser APIs Required

1. **DOM API**
   - `document.querySelector()` - Select elements
   - `document.getElementById()` - Get elements by ID
   - `element.addEventListener()` - Attach event listeners
   - `element.style.*` - Manipulate inline styles
   - `element.classList.*` - Manage CSS classes

2. **Cookie API**
   - `document.cookie` - Read/write cookies
   - Cookie format: `name=value; expires=date; path=/`

3. **Animation API (Optional)**
   - `requestAnimationFrame()` - Batch DOM updates for performance

### Internal Dependencies

1. **Existing CSS Variables**
   - `--crimson` (#6F1F1E)
   - `--crimson-glow` (#8b2726)
   - `--crimson-pale` (#c45a59)
   - `--smoke-light` (#3d2f27)
   - `--vellum` (#f5ede0)
   - `--ash-light` (#9a8878)
   - `--white` (#fff8f0)
   - `--font-display` ('Cinzel', serif)
   - `--font-body` ('Cormorant Garamond', serif)

2. **Existing DOM Elements**
   - `.reader-sidebar` - Container for settings button
   - `.epub-chapter` - Target for style application
   - `#reader-main` - Target for background color

3. **Existing JavaScript Variables**
   - `readerFontSize` - Global font size state
   - `readerLineHeight` - Global line height state
   - `readerTheme` - Global theme state
   - `applyReaderStyles()` - Existing function to apply styles

4. **Icon Assets**
   - `icons copy/1.svg` - Active/hover settings icon
   - `icons copy/2.svg` - Inactive settings icon

### Browser Compatibility

- Modern browsers with ES6+ support
- Chrome 60+, Firefox 60+, Safari 12+, Edge 79+
- Cookie support required (enabled by default)
- No polyfills needed for target browsers
